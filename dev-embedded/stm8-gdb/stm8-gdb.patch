--- ../../../gentoo/sys-devel/gdb/gdb-12.1-r3.ebuild	2023-01-28 20:40:35.000000000 +0100
+++ stm8-gdb-13.1.90_p20230325.ebuild 2023-04-30 18:11:53.197269226 +0200
@@ -6,6 +6,8 @@
 PYTHON_COMPAT=( python3_{9..11} )
 inherit flag-o-matic python-single-r1 strip-linguas toolchain-funcs
 
+CTARGET=stm8-none-elf32
+
 export CTARGET=${CTARGET:-${CHOST}}
 
 if [[ ${CTARGET} == ${CHOST} ]] ; then
@@ -29,8 +31,8 @@
 		;;
 	*)
 		# Normal upstream release
-		SRC_URI="mirror://gnu/gdb/${P}.tar.xz
-			ftp://sourceware.org/pub/gdb/releases/${P}.tar.xz"
+		SRC_URI="mirror://gnu/gdb/gdb-12.1.tar.xz
+			ftp://sourceware.org/pub/gdb/releases/gdb-12.1.tar.xz"
 		;;
 esac
 
@@ -44,7 +46,7 @@
 SLOT="0"
 
 if [[ ${PV} != 9999* ]] ; then
-	KEYWORDS="~alpha amd64 arm arm64 hppa ~ia64 ~m68k ~mips ppc ppc64 ~riscv ~s390 sparc x86 ~x64-cygwin ~amd64-linux ~x86-linux ~x64-macos ~sparc-solaris ~sparc64-solaris ~x64-solaris ~x86-solaris"
+	KEYWORDS="~alpha ~amd64 ~arm ~arm64 ~hppa ~ia64 ~m68k ~mips ~ppc ~ppc64 ~riscv ~s390 ~sparc ~x86 ~x64-cygwin ~amd64-linux ~x86-linux ~x64-macos ~sparc-solaris ~sparc64-solaris ~x64-solaris ~x86-solaris"
 fi
 
 IUSE="cet guile lzma multitarget nls +python +server sim source-highlight test vanilla xml xxhash"
@@ -89,12 +91,30 @@
 "
 
 PATCHES=(
+	"${FILESDIR}"/${P}-0001-First-commit-for-stm8-binutils-gdb.patch
+	"${FILESDIR}"/${P}-0002-added-clear_proceed_status-in-run_command_1-causing-.patch
+	"${FILESDIR}"/${P}-0005-Fixed-printf-formatting-warnings.patch
+	"${FILESDIR}"/${P}-0006-Numerous-changes-and-bug-fixes.patch
+	"${FILESDIR}"/${P}-0007-Added-gc-sections-and-hi8-lo8-hh8.patch
+	"${FILESDIR}"/${P}-0008-Add-STM8-reloc-ops-by-default.patch
+	"${FILESDIR}"/${P}-0009-Fixed-typo-in-STM8-opcode-list-definition.patch
+	"${FILESDIR}"/${P}-0010-Replaced-C99-code-with-ANSI-C-equivalent.patch
+	"${FILESDIR}"/${P}-0011-Fix-bccm-instruction.patch
+	"${FILESDIR}"/${P}-0012-Include-stm8-while-building-multi-architecture-gdb.patch
+	"${FILESDIR}"/${P}-0013-Implemented-.s-short-addressing-mode-modifer-to-inde.patch
+	"${FILESDIR}"/${P}-0015-Refactored-lo8-hi8-hh8-and-removed-the-special-push-.patch
+	"${FILESDIR}"/${P}-0016-Fixed-compilation-error-in-gdb-stm8-tdep.c.patch
+	"${FILESDIR}"/${P}-0020-adapt-stm8-support-to-gdb-version-12.patch
 	"${FILESDIR}"/${PN}-8.3.1-verbose-build.patch
 	"${FILESDIR}"/${P}-readline-8.2-build.patch
 	"${FILESDIR}"/${P}-core-file-detach.patch
 	"${FILESDIR}"/${P}-configure-clang16.patch
 )
 
+S=${WORKDIR}/gdb-12.1
+#CFLAGS="${CFLAGS} -Werror"
+#CXXFLAGS="${CXXFLAGS} -DGDBARCH_DEBUG=3"
+
 pkg_setup() {
 	use python && python-single-r1_pkg_setup
 }
@@ -218,7 +238,14 @@
 	# ensure proper compiler is detected for Clang builds: bug #831202
 	export GCC_FOR_TARGET="${CC_FOR_TARGET:-$(tc-getCC)}"
 
-	econf "${myconf[@]}"
+	#econf "${myconf[@]}"
+	./configure --prefix="${EPREFIX}"/usr --build=${CHOST} --host=${CHOST} --target=${CTARGET} \
+	--mandir="${EPREFIX}"/usr/share/man --infodir="${EPREFIX}"/usr/share/info \
+	--datadir="${EPREFIX}"/usr/share --sysconfdir="${EPREFIX}"/etc \
+	--localstatedir="${EPREFIX}"/var/lib --datarootdir="${EPREFIX}"/usr/${CTARGET}/share \
+	--docdir="${EPREFIX}"/usr/share/doc/${PF} --htmldir=/usr/share/doc/${PF} \
+	--program-prefix=stm8- --includedir="${EPREFIX}"/usr/${CTARGET}/include \
+	"${myconf[@]}"
 }
 
 src_compile() {
